{% from "_forms_helpers.jinja2" import render_field, render_submit, render_selectfield, render_search_field %}

{% macro render_jobs_form_fields(form, form_type) %}

    {{ form.csrf_token() }}

    {% if form_type=='create_admin' %}
        {{ render_selectfield(form.company_id) }}
    {% endif %}

    {{ render_field(form.title) }}
    {{ render_field(form.description, rows="5") }}

    {{ get_location__by_postcode(form) }}
    <br>

    {% if form_type in ('create_admin', 'create_hr') %}
        {{ render_selectfield(form.duration) }}
    {% endif %}


    {{ render_submit("Create job" if form_type == 'create' else "Save job") }}

{% endmacro %}


{% macro get_location__by_postcode(form) %}

    {{ render_search_field(form.postcode, on_click='get_location_from_postcode()') }}

    <div class="row">
        <div class="col-5"></div>
        <div class="col-7">
            <div id="mapid" style="height: 300px"></div>
        </div>
        {{ form.latitude() }}
        {{ form.longitude() }}
        {{ form.admin_district() }}
    </div>

{% endmacro %}

{% macro search_postcode(initial_location) %}

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
          integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
            integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
            crossorigin=""></script>
    <script>

        var map;

        function initmap() {
            // set up the map
            map = new L.Map('mapid');

            // create the tile layer with correct attribution
            var osmUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
            var osmAttrib = 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors';
            var osm = new L.TileLayer(osmUrl, {minZoom: 8, maxZoom: 12, attribution: osmAttrib});

            map.setView(new L.LatLng(55.952141, -3.189296), 9);
            map.addLayer(osm);

            return map
        }

        var marker;
        function createMarker(latlng) {
            if (marker == null) {
                marker = L.marker(latlng).addTo(mymap);
            }
            marker.setLatLng(latlng);
            map.setView(latlng, 9);
        }

        function createMarkerFromFields() {
            createMarker({
                'lat': $('#latitude').val(),
                'lng': $('#longitude').val()
            })
        }

        function onMapClick(e) {
            document.getElementById('latitude').value = e.latlng.lat;
            document.getElementById('longitude').value = e.latlng.lng;
            createMarker(e.latlng);
        }

        var mymap = initmap();
        mymap.on('click', onMapClick);

        createMarkerFromFields();

        function get_location_from_postcode() {
            var postcode = $('#postcode').val();

            $.get('/postcode/' + postcode).done(
                function (response) {
                    $('#latitude').val(response.latitude);
                    $('#longitude').val(response.longitude);
                    $('#admin_district').val(response.admin_district);
                    latLng = new L.LatLng(response.latitude, response.longitude);
                    createMarker(latLng)
                }
            );
        }

    </script>

{% endmacro %}
